<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureEthChat</title>
    <style>
        :root { --primary-color: #3498db; --dark-color: #2c3e50; --light-color: #ecf0f1; --success-color: #2ecc71; --error-color: #e74c3c; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f9f9f9; color: var(--dark-color); line-height: 1.6; height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 800px; margin: 0 auto; padding: 0 1rem; flex: 1; display: flex; flex-direction: column; }
        header { background-color: var(--primary-color); color: #fff; padding: 1rem; text-align: center; }
        .app-container { display: flex; flex: 1; padding: 1rem 0; }
        .setup-container, .chat-container { background-color: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .setup-container { display: flex; flex-direction: column; gap: 1rem; }
        .chat-container { display: none; flex: 1; flex-direction: column; height: 100%; }
        .connection-info { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-color); }
        .status { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; margin-right: 0.5rem; background-color: var(--error-color); }
        .status-indicator.connected { background-color: var(--success-color); }
        .connection-id, .eth-address-display { padding: 0.5rem; background-color: var(--light-color); border-radius: 4px; font-family: monospace; margin-top: 0.5rem; word-break: break-all; }
        .messages { flex: 1; overflow-y: auto; padding: 1rem; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; min-height: 300px; }
        .message { padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 8px; max-width: 80%; position: relative; }
        .message.sent { background-color: var(--primary-color); color: #fff; margin-left: auto; }
        .message.received { background-color: var(--light-color); margin-right: auto; }
        .message-form { display: flex; gap: 1rem; }
        .form-control { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-control label { font-weight: bold; }
        .form-control input, .form-control textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; font-family: inherit; }
        textarea { resize: none; flex: 1; }
        button { padding: 0.75rem 1.5rem; background-color: var(--primary-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .alert { padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 4px; background-color: var(--light-color); }
        .alert.error { background-color: #fadbd8; color: var(--error-color); }
        .alert.success { background-color: #d5f5e3; color: var(--success-color); }
        .copy-btn { padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-left: 0.5rem; cursor: pointer; }
        .peer-connection { margin-top: 1rem; }
        .status-message { font-style: italic; text-align: center; color: #7f8c8d; margin: 1rem 0; }
        #contactsList { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem; }
        .contact-item { padding: 0.5rem; cursor: pointer; border-bottom: 1px solid var(--light-color); display: flex; justify-content: space-between; align-items: center; }
        .contact-item:last-child { border-bottom: none; }
        .contact-item:hover { background-color: var(--light-color); }
        .contact-item span { font-weight: bold; }
        .contact-item small { font-family: monospace; font-size: 0.8em; color: #7f8c8d; }
        .delete-contact-btn { background-color: var(--error-color); color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.7em; margin-left: 0.5rem; }
        .flex-row { display: flex; gap: 1rem; align-items: flex-end; }
        .flex-grow { flex-grow: 1; }
        h2, h3 { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <header>
        <h1>SecureEthChat</h1>
        <p>E2E Encrypted P2P Chat via ETH Address</p>
    </header>

    <div class="container">
        <div id="setup" class="setup-container">
            <h3>Your Info</h3>
            <div id="setupAlert" class="alert" style="display: none;"></div>
            <div class="form-control">
                <label for="username">Your Name</label>
                <input type="text" id="username" placeholder="Enter your display name" required>
            </div>
            <div class="form-control">
                <label for="ethAddress">Your ETH Address</label>
                <input type="text" id="ethAddress" placeholder="Enter your 0x... address" required pattern="^0x[a-fA-F0-9]{40}$">
            </div>
            <button id="initializeBtn" class="btn">Initialize & Show My Info</button>

            <div id="userInfo" style="display: none; margin-top: 1rem;">
                <div class="form-control">
                    <label>Your Connection ID (Share this):</label>
                    <div class="connection-id">
                        <span id="myConnectionId">Initializing...</span>
                        <button id="copyBtn" class="copy-btn">Copy</button>
                    </div>
                </div>
                 <div class="form-control">
                    <label>Your ETH Address:</label>
                    <div class="eth-address-display">
                        <span id="myEthAddressDisplay"></span>
                    </div>
                </div>
            </div>

            <h3 style="margin-top: 1rem;">Contacts</h3>
            <div id="contactsList">
                <p style="padding: 0.5rem; color: #7f8c8d;">No contacts saved yet.</p>
            </div>

            <h3 style="margin-top: 1rem;">Connect with New Peer</h3>
            <div class="form-control">
                <label for="peerNameInput">Peer's Name</label>
                <input type="text" id="peerNameInput" placeholder="Enter peer's display name">
            </div>
            <div class="flex-row">
                <div class="form-control flex-grow">
                    <label for="peerEthAddress">Peer's ETH Address</label>
                    <input type="text" id="peerEthAddress" placeholder="Enter peer's 0x... address" pattern="^0x[a-fA-F0-9]{40}$">
                </div>
                <div class="form-control flex-grow">
                    <label for="peerIdInput">Peer's Connection ID</label>
                    <input type="text" id="peerIdInput" placeholder="Paste peer's connection ID">
                </div>
            </div>
            <button id="connectBtn" class="btn" disabled>Connect & Add Contact</button>
        </div>

        <div id="chat" class="chat-container">
            <div class="connection-info">
                <div class="status">
                    <div id="connectionStatus" class="status-indicator"></div>
                    <span id="statusText">Disconnected</span>
                    <button id="backToSetupBtn" class="btn" style="margin-left: auto; padding: 0.5rem 1rem;">Back to Setup</button>
                </div>
                <div id="peerConnectionInfo" class="peer-connection" style="display: none;">
                    <strong>Chatting with:</strong> <span id="peerNameDisplay">-</span> (<small id="peerEthAddressDisplay">-</small>)
                    <button id="disconnectBtn" class="btn" style="float: right">Disconnect</button>
                </div>
            </div>
            <div id="messages" class="messages">
                <p class="status-message" id="welcomeMessage">Initialize your info or connect to a peer to start chatting.</p>
            </div>
            <div class="message-form">
                <textarea id="messageInput" placeholder="Type your message here..." rows="2" disabled></textarea>
                <button id="sendBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const setupView = document.getElementById('setup');
            const chatView = document.getElementById('chat');
            const usernameInput = document.getElementById('username');
            const ethAddressInput = document.getElementById('ethAddress');
            const initializeBtn = document.getElementById('initializeBtn');
            const setupAlert = document.getElementById('setupAlert');
            const userInfoDiv = document.getElementById('userInfo');
            const myConnectionIdSpan = document.getElementById('myConnectionId');
            const myEthAddressDisplaySpan = document.getElementById('myEthAddressDisplay');
            const copyBtn = document.getElementById('copyBtn');
            const contactsListDiv = document.getElementById('contactsList');
            const peerNameInput = document.getElementById('peerNameInput');
            const peerEthAddressInput = document.getElementById('peerEthAddress');
            const peerIdInput = document.getElementById('peerIdInput');
            const connectBtn = document.getElementById('connectBtn');
            const connectionStatus = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const peerConnectionInfo = document.getElementById('peerConnectionInfo');
            const peerNameDisplay = document.getElementById('peerNameDisplay');
            const peerEthAddressDisplay = document.getElementById('peerEthAddressDisplay');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const backToSetupBtn = document.getElementById('backToSetupBtn');
            const messagesContainer = document.getElementById('messages');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            let peer = null;
            let connection = null;
            let myUsername = '';
            let myEthAddress = '';
            let cryptoKey = null;
            let iv = null;
            let contacts = [];

            const ETH_ADDRESS_REGEX = /^0x[a-fA-F0-9]{40}$/;

            function loadContacts() {
                const storedContacts = localStorage.getItem('secureEthChatContacts');
                contacts = storedContacts ? JSON.parse(storedContacts) : [];
                renderContacts();
            }

            function saveContacts() {
                localStorage.setItem('secureEthChatContacts', JSON.stringify(contacts));
            }

            function addOrUpdateContact(newContact) {
                const index = contacts.findIndex(c => c.address === newContact.address || c.peerId === newContact.peerId);
                if (index > -1) {
                    contacts[index] = { ...contacts[index], ...newContact };
                } else {
                    contacts.push(newContact);
                }
                saveContacts();
                renderContacts();
            }

             function deleteContact(address) {
                contacts = contacts.filter(c => c.address !== address);
                saveContacts();
                renderContacts();
            }

            function renderContacts() {
                contactsListDiv.innerHTML = '';
                if (contacts.length === 0) {
                    contactsListDiv.innerHTML = '<p style="padding: 0.5rem; color: #7f8c8d;">No contacts saved yet.</p>';
                    return;
                }
                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.classList.add('contact-item');
                    item.innerHTML = `
                        <div>
                            <span>${contact.name || 'Unknown Name'}</span><br>
                            <small>${contact.address}</small>
                        </div>
                        <button class="delete-contact-btn" data-address="${contact.address}">X</button>
                    `;
                    item.querySelector('span').addEventListener('click', () => {
                        if (!peer || !contact.peerId) {
                            showAlert("Initialize your info first or contact has no Peer ID.", "error", setupAlert);
                            return;
                        }
                        if (connection && connection.open) {
                            showAlert("Already connected. Disconnect first.", "error", setupAlert);
                            return;
                        }
                        connectToPeer(contact.peerId, contact.name, contact.address);
                    });
                     item.querySelector('.delete-contact-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteContact(e.target.dataset.address);
                    });
                    contactsListDiv.appendChild(item);
                });
            }

            async function generateEncryptionKey() {
                cryptoKey = await window.crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
                iv = window.crypto.getRandomValues(new Uint8Array(12));
                return { key: await exportKey(cryptoKey), iv: Array.from(iv) };
            }

            async function exportKey(key) {
                const exported = await window.crypto.subtle.exportKey("raw", key);
                return Array.from(new Uint8Array(exported));
            }

            async function importKey(keyData) {
                const keyBuffer = new Uint8Array(keyData);
                return await window.crypto.subtle.importKey("raw", keyBuffer, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
            }

            async function encrypt(message) {
                const encoder = new TextEncoder();
                const encodedMessage = encoder.encode(message);
                const encryptedBuffer = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, cryptoKey, encodedMessage);
                return Array.from(new Uint8Array(encryptedBuffer));
            }

            async function decrypt(encryptedData, key, ivData) {
                try {
                    const decryptedBuffer = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(ivData) }, key, new Uint8Array(encryptedData));
                    return new TextDecoder().decode(decryptedBuffer);
                } catch (error) {
                    console.error("Decryption error:", error);
                    return "⚠️ [Decryption Failed]";
                }
            }

            function initializeApp() {
                const name = usernameInput.value.trim();
                const address = ethAddressInput.value.trim();

                if (!name) {
                    showAlert("Please enter your display name", "error", setupAlert); return;
                }
                if (!address || !ETH_ADDRESS_REGEX.test(address)) {
                    showAlert("Please enter a valid Ethereum address (0x...)", "error", setupAlert); return;
                }

                myUsername = name;
                myEthAddress = address;
                initializeBtn.disabled = true;
                initializeBtn.textContent = 'Initializing...';
                setupAlert.style.display = 'none';

                if (peer) {
                    peer.destroy();
                    peer = null;
                }

                initializePeer();
            }

            function initializePeer() {
                try {
                    peer = new Peer({ debug: 0 });

                    peer.on('open', (id) => {
                        myConnectionIdSpan.textContent = id;
                        myEthAddressDisplaySpan.textContent = myEthAddress;
                        userInfoDiv.style.display = 'block';
                        connectBtn.disabled = false;
                        initializeBtn.disabled = false;
                        initializeBtn.textContent = 'Re-Initialize Peer ID';
                         showAlert(`Peer Initialized. Your ID: ${id}`, "success", setupAlert);
                    });

                    peer.on('connection', handleIncomingConnection);

                    peer.on('error', (err) => {
                        console.error('PeerJS error:', err);
                         showAlert(`Peer error: ${err.type} - ${err.message}`, "error", setupAlert);
                        connectBtn.disabled = true;
                        initializeBtn.disabled = false;
                        initializeBtn.textContent = 'Initialize & Show My Info';
                        userInfoDiv.style.display = 'none';
                        if (chatView.style.display === 'flex') {
                            handleConnectionClosed("Peer Error");
                        }
                    });

                     peer.on('disconnected', () => {
                        showAlert("Peer disconnected from server. Attempting to reconnect...", "error", setupAlert);
                        if (!peer.destroyed) {
                           peer.reconnect();
                        }
                    });

                    peer.on('close', () => {
                        showAlert("Peer connection closed. Please re-initialize.", "error", setupAlert);
                        connectBtn.disabled = true;
                        initializeBtn.disabled = false;
                        initializeBtn.textContent = 'Initialize & Show My Info';
                         userInfoDiv.style.display = 'none';
                         if (chatView.style.display === 'flex') {
                            handleConnectionClosed("Peer Closed");
                         }
                    });

                } catch (error) {
                    console.error('Initialization error:', error);
                    showAlert(`Failed to initialize PeerJS: ${error.message}`, "error", setupAlert);
                    initializeBtn.disabled = false;
                    initializeBtn.textContent = 'Initialize & Show My Info';
                }
            }

             function connectAndAdd() {
                const targetPeerId = peerIdInput.value.trim();
                const targetName = peerNameInput.value.trim();
                const targetEthAddress = peerEthAddressInput.value.trim();

                if (!peer) {
                    showAlert("Initialize your info first!", "error", setupAlert); return;
                }
                 if (!targetPeerId) {
                    showAlert("Enter the Peer's Connection ID", "error", setupAlert); return;
                }
                if (!targetEthAddress || !ETH_ADDRESS_REGEX.test(targetEthAddress)) {
                    showAlert("Enter a valid Peer ETH Address", "error", setupAlert); return;
                }
                if (!targetName) {
                    showAlert("Enter the Peer's Name", "error", setupAlert); return;
                }
                 if (targetPeerId === peer.id) {
                    showAlert("Cannot connect to yourself.", "error", setupAlert); return;
                }
                if (connection && connection.open) {
                    showAlert("Already connected. Disconnect first.", "error", setupAlert); return;
                }

                connectToPeer(targetPeerId, targetName, targetEthAddress);
            }


            async function connectToPeer(peerId, name, address) {
                try {
                    switchToChatView();
                    updateStatus('connecting');
                    welcomeMessage.textContent = `Connecting to ${name || 'peer'} (${address})...`;
                    addStatusMessage(`Attempting connection to ${name || 'peer'}...`);

                    const encryptionData = await generateEncryptionKey();

                    connection = peer.connect(peerId, {
                        reliable: true,
                        metadata: { username: myUsername, ethAddress: myEthAddress, encryptionData: encryptionData }
                    });

                    setupConnectionHandlers(connection, name, address);

                } catch (error) {
                    console.error('Connection error:', error);
                    showAlert(`Failed to connect: ${error.message}`, "error", setupAlert);
                    handleConnectionClosed("Connection Error");
                }
            }

            async function handleIncomingConnection(conn) {
                if (connection && connection.open) {
                    console.log("Rejecting incoming connection, already connected.");
                    conn.close();
                    return;
                }

                connection = conn;
                const peerMetadata = connection.metadata || {};
                const peerUsername = peerMetadata.username || 'Unknown';
                const peerEthAddr = peerMetadata.ethAddress || 'Unknown Address';

                if (peerMetadata.encryptionData) {
                    try {
                        cryptoKey = await importKey(peerMetadata.encryptionData.key);
                        iv = new Uint8Array(peerMetadata.encryptionData.iv);
                    } catch (e) {
                        console.error("Failed to import key from incoming connection", e);
                         addStatusMessage("Error setting up encryption with peer.");
                         conn.close();
                         return;
                    }
                } else {
                    console.warn("No encryption data received from peer.");
                    addStatusMessage("Warning: Peer did not send encryption info.");
                     // Decide if you want to proceed without E2E encryption or close
                    // conn.close(); return;
                }

                switchToChatView();
                addStatusMessage(`Incoming connection from ${peerUsername} (${peerEthAddr}).`);
                setupConnectionHandlers(connection, peerUsername, peerEthAddr);
                // Accept the connection implicitly by setting up handlers
                 // No explicit accept needed, PeerJS handles it via event listeners
            }

             function setupConnectionHandlers(conn, peerUsername, peerEthAddr) {
                conn.on('open', () => {
                    handleConnectionEstablished(conn, peerUsername, peerEthAddr);
                });
                conn.on('data', handleReceivedData);
                conn.on('close', () => handleConnectionClosed("Peer Disconnected"));
                conn.on('error', (err) => {
                     console.error('Connection error:', err);
                     addStatusMessage(`Connection error: ${err.message}`);
                     handleConnectionClosed("Connection Error");
                 });
            }

            function handleConnectionEstablished(conn, peerUsername, peerEthAddr) {
                updateStatus('connected');
                peerNameDisplay.textContent = peerUsername;
                peerEthAddressDisplay.textContent = peerEthAddr;
                peerConnectionInfo.style.display = 'block';
                welcomeMessage.style.display = 'none'; // Hide initial message
                messageInput.disabled = false;
                sendBtn.disabled = false;
                disconnectBtn.disabled = false;
                addStatusMessage(`Secure connection established with ${peerUsername}.`);

                // Add/Update contact
                addOrUpdateContact({
                    name: peerUsername,
                    address: peerEthAddr,
                    peerId: conn.peer // Store the connected peer's PeerJS ID
                });
                 // Clear connect form on successful connection
                peerNameInput.value = '';
                peerEthAddressInput.value = '';
                peerIdInput.value = '';
            }

            async function handleReceivedData(data) {
                 if (data.type === 'message' && cryptoKey && iv) {
                    const decryptedMessage = await decrypt(data.content, cryptoKey, iv);
                    addMessage(decryptedMessage, 'received');
                 } else if (data.type === 'message') {
                    addMessage("⚠️ [Received unencrypted/undecryptable message]", 'received');
                 } else {
                    console.log("Received unknown data type: ", data);
                 }
            }

             function handleConnectionClosed(reason = "Closed") {
                 addStatusMessage(`Connection ${reason}.`);
                updateStatus('disconnected');
                peerConnectionInfo.style.display = 'none';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                disconnectBtn.disabled = true;
                cryptoKey = null;
                iv = null;
                 if (connection) {
                    connection.close(); // Ensure cleanup
                 }
                connection = null;
                 welcomeMessage.textContent = "Disconnected. Select a contact or connect to a new peer.";
                 welcomeMessage.style.display = 'block';
                 // Don't switch view automatically, allow user to go back
            }

            function disconnectPeer() {
                if (connection) {
                    connection.close();
                    handleConnectionClosed("Disconnected by User");
                }
            }

            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message || !connection || !cryptoKey || !iv) return;

                try {
                    const encryptedData = await encrypt(message);
                    connection.send({ type: 'message', content: encryptedData });
                    addMessage(message, 'sent');
                    messageInput.value = '';
                } catch (error) {
                    console.error('Error sending message:', error);
                    addStatusMessage('Failed to encrypt or send message.');
                }
            }

            function addMessage(message, type) {
                welcomeMessage.style.display = 'none'; // Hide welcome once messages start
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', type);
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function addStatusMessage(message) {
                 welcomeMessage.style.display = 'none';
                const statusElement = document.createElement('p');
                statusElement.classList.add('status-message');
                statusElement.textContent = message;
                messagesContainer.appendChild(statusElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function updateStatus(status) {
                connectionStatus.className = 'status-indicator';
                switch (status) {
                    case 'connecting': statusText.textContent = 'Connecting...'; break;
                    case 'connected': statusText.textContent = 'Connected'; connectionStatus.classList.add('connected'); break;
                    case 'disconnected': statusText.textContent = 'Disconnected'; break;
                    case 'error': statusText.textContent = 'Error'; break;
                    default: statusText.textContent = 'Idle';
                }
            }

            function showAlert(message, type, element) {
                 element.textContent = message;
                 element.className = `alert ${type}`;
                 element.style.display = 'block';
                 setTimeout(() => { element.style.display = 'none'; }, 5000);
            }

            function copyConnectionId() {
                 if (!peer || !peer.id) return;
                navigator.clipboard.writeText(peer.id)
                    .then(() => {
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
                    })
                    .catch(err => console.error('Failed to copy: ', err));
            }

             function switchToChatView() {
                setupView.style.display = 'none';
                chatView.style.display = 'flex';
            }

            function switchToSetupView() {
                 if (connection && connection.open) {
                     disconnectPeer();
                 }
                 messagesContainer.innerHTML = ''; // Clear chat messages
                 welcomeMessage.textContent = "Initialize your info or connect to a peer to start chatting.";
                 welcomeMessage.style.display = 'block';
                 updateStatus('disconnected');
                 peerConnectionInfo.style.display = 'none';
                 messageInput.disabled = true;
                 sendBtn.disabled = true;
                 disconnectBtn.disabled = true;

                setupView.style.display = 'flex';
                chatView.style.display = 'none';
            }


            initializeBtn.addEventListener('click', initializeApp);
            copyBtn.addEventListener('click', copyConnectionId);
            connectBtn.addEventListener('click', connectAndAdd);
            sendBtn.addEventListener('click', sendMessage);
            disconnectBtn.addEventListener('click', disconnectPeer);
            backToSetupBtn.addEventListener('click', switchToSetupView);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            loadContacts();
        });
    </script>
</body>
</html>